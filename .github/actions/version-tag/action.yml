# You can find code and docs here: https://github.com/allthings/github-action-tools
name: version-tag
description: "Creates a git version tag"
inputs:
  trigger-workflow-name:
    description: "Name of workflow that is triggered after creating tag"
    required: false

runs:
  using: "composite"
  steps:
    - name: Set PATH
      shell: bash
      run: |
        echo "/bin" >> $GITHUB_PATH
        echo "/sbin" >> $GITHUB_PATH
        echo "/usr/bin" >> $GITHUB_PATH
        echo "/usr/sbin" >> $GITHUB_PATH
        echo "/usr/local/bin" >> $GITHUB_PATH
        echo "/usr/local/sbin" >> $GITHUB_PATH

    - name: create new tag
      shell: bash
      env:
        WORKFLOW_NAME: ${{ inputs['trigger-workflow-name'] }}
      run: |
        set -eo pipefail

        git config user.name "Allthings Bot"
        git config user.email "bot@allthings.me"

        # Suppress error output (2>/dev/null) and use '|| true'
        # This lets the script continue if no tags are found.
        currentVersion="$(git describe --tags `git rev-list --tags --max-count=1` 2>/dev/null || true)"

        if [ "$currentVersion" = "" ]; then 
          currentVersion="v0.0.0"
        fi

        latestVersion="${currentVersion//v[0-9]*.[0-9]*./}"
        ((++latestVersion))
        newVersion="${currentVersion%.*}.$latestVersion"
        git tag -a $newVersion -m "Release new version: $newVersion"

        git push origin $newVersion

        if [ ! -z "${{ env.WORKFLOW_NAME }}" ]; then 
          gh workflow run ${{ env.WORKFLOW_NAME }} --ref $newVersion
        fi
